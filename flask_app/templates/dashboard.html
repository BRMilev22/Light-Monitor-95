{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="window" style="max-width: 600px;">
    <div class="window-title">
        <span class="window-title-text">
            <span>üí°</span>
            <span>Light-Level Monitor - {{ current_user.username }}</span>
        </span>
        <div class="window-buttons">
            <button class="window-btn">_</button>
            <button class="window-btn">‚ñ°</button>
            <button class="window-btn" onclick="window.location.href='{{ url_for('logout') }}'">√ó</button>
        </div>
    </div>
    <div class="window-content">
        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
            {% for category, message in messages %}
            <div class="flash flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <div class="dashboard-grid">
            <!-- Light Level Display -->
            <fieldset>
                <legend>üìä Current Light Level</legend>
                <div class="data-box">
                    <div class="data-value" id="light-value">{{ data.light_level }}</div>
                    <div class="data-label">Range: 0 (dark) - 1023 (bright)</div>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="light-bar" style="width: {{ (data.light_level / 1023 * 100)|int }}%">
                    </div>
                </div>
            </fieldset>

            <!-- LED Status -->
            <fieldset>
                <legend>üí° LED Status</legend>
                <div class="data-box text-center">
                    <div class="flex-row" style="justify-content: center;">
                        <span id="led-indicator"
                            class="led-indicator {% if data.light_level < data.threshold %}led-on{% else %}led-off{% endif %}"></span>
                        <span id="led-text" style="font-size: 18px; font-weight: bold;">
                            {% if data.light_level < data.threshold %}ON{% else %}OFF{% endif %} </span>
                    </div>
                    <div class="data-label mt-10">LED turns ON when light is below threshold</div>
                </div>
            </fieldset>
        </div>

        <!-- Threshold Control -->
        <fieldset>
            <legend>‚öôÔ∏è Threshold Control</legend>
            <div class="flex-between">
                <label for="threshold">Set threshold value:</label>
                <span id="threshold-display">{{ data.threshold }}</span>
            </div>
            <input type="range" id="threshold" min="0" max="1023" value="{{ data.threshold }}"
                oninput="updateThreshold(this.value)">
            <div class="flex-between mt-10">
                <span>0 (very dark)</span>
                <span>1023 (very bright)</span>
            </div>
            <div class="mt-10 text-center">
                <button class="btn btn-primary" onclick="sendThreshold()">Apply</button>
                <button class="btn"
                    onclick="document.getElementById('threshold').value=768; updateThreshold(768);">Reset (768)</button>
            </div>
        </fieldset>

        <!-- Connection Status -->
        <fieldset>
            <legend>üîå Arduino Status</legend>
            <div class="data-box">
                <div id="arduino-status">{{ data.status }}</div>
            </div>
        </fieldset>

        <div class="text-center mt-10">
            <a href="{{ url_for('logout') }}" class="btn">Log Out</a>
        </div>
    </div>
    <div class="status-bar">
        <div class="status-section" id="status-text">Connected - Refreshing every 500ms</div>
        <div class="status-section" style="flex: 0; min-width: 100px;" id="status-time"></div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Update threshold display
    function updateThreshold(value) {
        document.getElementById('threshold-display').textContent = value;
    }

    // Send threshold to server
    function sendThreshold() {
        const threshold = document.getElementById('threshold').value;
        const formData = new FormData();
        formData.append('threshold', threshold);

        fetch('/api/threshold', {
            method: 'POST',
            body: formData
        })
            .then(function (response) { return response.json(); })
            .then(function (data) {
                if (data.success) {
                    document.getElementById('status-text').textContent = 'Threshold set to ' + data.threshold;
                } else {
                    document.getElementById('status-text').textContent = 'Error: ' + data.error;
                }
            })
            .catch(function (error) {
                document.getElementById('status-text').textContent = 'Connection error!';
            });
    }

    // Poll for live data updates
    function refreshData() {
        fetch('/api/data')
            .then(function (response) { return response.json(); })
            .then(function (data) {
                // Update light level
                document.getElementById('light-value').textContent = data.light_level;
                document.getElementById('light-bar').style.width = (data.light_level / 1023 * 100) + '%';

                // Update LED indicator
                var ledIndicator = document.getElementById('led-indicator');
                var ledText = document.getElementById('led-text');
                if (data.light_level < data.threshold) {
                    ledIndicator.className = 'led-indicator led-on';
                    ledText.textContent = 'ON';
                } else {
                    ledIndicator.className = 'led-indicator led-off';
                    ledText.textContent = 'OFF';
                }

                // Update Arduino status
                document.getElementById('arduino-status').textContent = data.status;

                // Update status bar
                document.getElementById('status-text').textContent = 'Connected - Light: ' + data.light_level;
            })
            .catch(function (error) {
                document.getElementById('status-text').textContent = 'Connection lost!';
            });
    }

    // Update time display
    function updateTime() {
        var now = new Date();
        document.getElementById('status-time').textContent =
            now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    // Start polling immediately and then every 500ms
    refreshData();
    setInterval(refreshData, 500);
    setInterval(updateTime, 1000);
    updateTime();
</script>
{% endblock %}